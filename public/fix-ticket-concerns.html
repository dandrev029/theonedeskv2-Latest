<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Ticket Concerns Departments</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #18A5A7;
            border-bottom: 2px solid #18A5A7;
            padding-bottom: 10px;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background-color: #18A5A7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #148f91;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Fix Ticket Concerns Departments</h1>
    
    <div class="card">
        <h2>About This Tool</h2>
        <p>This tool helps fix issues with missing departments in the Ticket Concerns page. It will create the default departments if they don't exist in the database.</p>
        <p>Use this tool if you're seeing errors like:</p>
        <ul>
            <li>"No query results for model [App\Models\TicketConcern] departments"</li>
            <li>"Error 404 Not Found" on the Ticket Concerns page</li>
        </ul>
    </div>
    
    <div class="card">
        <h2>Fix Departments</h2>
        <p>Click the button below to fix the departments:</p>
        <button id="fixButton">Fix Departments</button>
        <div id="result" class="result" style="display: none;"></div>
    </div>
    
    <div class="card">
        <h2>Alternative Methods</h2>
        <p>If the button above doesn't work, you can try these alternative methods:</p>
        <ol>
            <li>Visit <a href="/api/fix-departments" target="_blank">/api/fix-departments</a> directly</li>
            <li>Visit <a href="/fix-departments.php" target="_blank">/fix-departments.php</a> directly</li>
            <li>Run <code>php artisan fix:ticket-concern-departments</code> from the command line</li>
        </ol>
    </div>
    
    <script>
        document.getElementById('fixButton').addEventListener('click', function() {
            const button = this;
            const resultDiv = document.getElementById('result');
            
            // Disable button and show loading state
            button.disabled = true;
            button.textContent = 'Fixing Departments...';
            resultDiv.style.display = 'none';
            
            // Try the API endpoint first
            fetch('/api/fix-departments')
                .then(response => response.json())
                .then(data => {
                    showResult(data, true);
                })
                .catch(error => {
                    // If API endpoint fails, try the PHP script
                    console.error('API endpoint failed, trying PHP script:', error);
                    return fetch('/fix-departments.php');
                })
                .then(response => {
                    if (response) return response.json();
                })
                .then(data => {
                    if (data) showResult(data, false);
                })
                .catch(error => {
                    console.error('Both methods failed:', error);
                    showResult({
                        success: false,
                        message: 'Failed to fix departments. Please try one of the alternative methods listed below.'
                    }, false);
                })
                .finally(() => {
                    // Re-enable button
                    button.disabled = false;
                    button.textContent = 'Fix Departments';
                });
                
            function showResult(data, fromApi) {
                resultDiv.innerHTML = '';
                resultDiv.className = 'result ' + (data.success ? 'success' : 'error');
                
                const source = fromApi ? 'API endpoint' : 'PHP script';
                const heading = document.createElement('h3');
                heading.textContent = data.success ? 'Success!' : 'Error';
                resultDiv.appendChild(heading);
                
                const message = document.createElement('p');
                message.textContent = data.message || (data.success ? 'Departments fixed successfully.' : 'Failed to fix departments.');
                resultDiv.appendChild(message);
                
                const sourceInfo = document.createElement('p');
                sourceInfo.textContent = `Source: ${source}`;
                resultDiv.appendChild(sourceInfo);
                
                if (data.created || data.existing) {
                    const details = document.createElement('pre');
                    details.textContent = JSON.stringify({
                        created: data.created || [],
                        existing: data.existing || []
                    }, null, 2);
                    resultDiv.appendChild(details);
                }
                
                resultDiv.style.display = 'block';
                
                // If successful, suggest refreshing the ticket concerns page
                if (data.success) {
                    const refreshNote = document.createElement('p');
                    refreshNote.innerHTML = '<strong>Next step:</strong> Please refresh the Ticket Concerns page to see if the issue is resolved.';
                    resultDiv.appendChild(refreshNote);
                }
            }
        });
    </script>
</body>
</html>
